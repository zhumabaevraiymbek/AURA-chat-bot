<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AURA - Air Astana Digital Concierge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        /* Убираем пространство на мобильных устройствах */
        html, body {
            margin: 0;
            padding: 0;
        }
        
        @media (max-width: 767px) {
            html, body {
                width: 100%;
                height: 100svh;
                max-height: 100svh;
            }
            
            #app {
                width: 100%;
                height: 100svh;
                max-height: 100svh;
            }
            
            .chat-container, .welcome-container {
                border-radius: 0 !important;
                box-shadow: none !important;
                height: 100svh !important;
                max-height: 100svh !important;
            }
        }
        
        /* На десктопе - фиксированная высота 600px */
        @media (min-width: 768px) {
            .chat-container, .welcome-container {
                height: 600px !important;
                max-height: 600px !important;
                position: relative !important;
            }
        }
        
        /* Безопасные зоны для iOS */
        @supports (padding: max(0px)) {
            .chat-container {
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }
        }
        
        /* Center all SVG icons properly */
        svg {
            display: block;
        }
        
        /* Icon wrapper classes should use flexbox */
        div[class*="w-"][class*="h-"] {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Ensure SVGs fill their containers properly */
        svg {
            width: 100%;
            height: 100%;
            flex-shrink: 0;
        }
        
        /* Loader animation */
        .loader-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1C2B4F 0%, #243550 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        
        .loader-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .loader-icon-wrapper {
            position: relative;
            animation: floatPulse 2s ease-in-out infinite;
        }
        
        @keyframes floatPulse {
            0%, 100% {
                transform: translateY(0px) scale(1);
            }
            50% {
                transform: translateY(-10px) scale(1.05);
            }
        }
        
        .loader-icon-container {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .loader-icon-container::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            padding: 3px;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            animation: rotate 2s linear infinite;
        }
        
        @keyframes rotate {
            to {
                transform: rotate(360deg);
            }
        }
        
        .loader-icon-container img {
            width: 48px;
            height: 48px;
            filter: brightness(0) invert(1);
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Header slide up animation for mobile keyboard */
        .chat-header {
            /* Header всегда видим */
        }
        
        .chat-container {
            /* Контейнер всегда стабильный */
        }
        
        /* На десктопе - фиксированная высота 600px */
        
        /* На мобильных - фиксированный контейнер */
        @media (max-width: 767px) {
            .chat-container, .welcome-container {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
            }
        }
        
        .chat-message {
            /* No animation - instant rendering */
            will-change: auto;
            /* Force immediate flex layout */
            contain: layout;
        }
        
        /* Force justify-end to apply immediately */
        .justify-end {
            justify-content: flex-end !important;
            display: flex !important;
        }
        
        /* Ensure flex containers render instantly with full width */
        .flex {
            will-change: auto;
            display: flex !important;
        }
        
        /* Force width on w-full */
        .w-full {
            width: 100% !important;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #64748b;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .grid-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M 40 0 L 0 0 0 40' fill='none' stroke='rgba(255,255,255,0.05)' stroke-width='1'/%3E%3C/svg%3E");
        }
        
        .message-bubble {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .quick-action-btn {
            transition: all 0.2s ease;
        }
        
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .flight-card {
            transition: all 0.2s ease;
        }
        
        .flight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-white md:bg-gradient-to-br md:from-slate-50 md:to-slate-100 min-h-screen flex items-start md:items-center justify-start md:justify-center p-0 m-0">
    
    <!-- Initial Loader Screen -->
    <div id="loader-screen" class="loader-screen">
        <div class="loader-icon-wrapper">
            <div class="loader-icon-container">
                <img 
                    src="https://airastana.com/favicon.svg" 
                    alt="Air Astana" 
                    onerror="this.style.display='none'"
                />
            </div>
        </div>
    </div>
    
    <!-- Chat Container -->
    <div id="app" class="w-full h-screen md:h-auto md:max-w-[440px] md:mx-auto"></div>

    <script>
        // SVG Icons as strings
        const icons = {
            plane: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>',
            briefcase: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
            users: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            send: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>',
            paperclip: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>',
            x: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',
            clock: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            checkCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>',
            alertCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>',
            xCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>',
            search: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>',
            creditCard: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>',
            fileText: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><line x1="10" x2="16" y1="13" y2="13"/><line x1="10" x2="16" y1="17" y2="17"/><line x1="10" x2="12" y1="9" y2="9"/></svg>',
            mapPin: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>',
            messageCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>'
        };

        // State management
        let state = {
            view: 'welcome', // 'welcome' or 'chat'
            messages: [],
            inputValue: '',
            isTyping: false
        };

        // Sample data
        const upcomingFlight = {
            flightNumber: 'KC 105',
            from: { code: 'ALA', city: 'Almaty', terminal: '1' },
            to: { code: 'GUW', city: 'Atyrau', terminal: '2' },
            departure: { time: '14:30', date: 'Feb 15' },
            arrival: { time: '16:45', date: 'Feb 15' },
            duration: '2h 15m',
            stops: 0,
            status: 'On time',
            operator: 'Air Astana',
            gate: 'A12'
        };

        const availableFlights = [
            {
                flightNumber: 'KC 201',
                from: { code: 'ALA', city: 'Almaty' },
                to: { code: 'TSE', city: 'Astana' },
                departure: { time: '09:15', date: 'Feb 15' },
                arrival: { time: '10:45', date: 'Feb 15' },
                duration: '1h 30m',
                stops: 0,
                price: { amount: 45000, currency: 'KZT' },
                availableSeats: 12,
                baggage: '23kg',
                operator: 'Air Astana'
            },
            {
                flightNumber: 'KC 203',
                from: { code: 'ALA', city: 'Almaty' },
                to: { code: 'TSE', city: 'Astana' },
                departure: { time: '15:30', date: 'Feb 15' },
                arrival: { time: '17:00', date: 'Feb 15' },
                duration: '1h 30m',
                stops: 0,
                price: { amount: 48500, currency: 'KZT' },
                availableSeats: 8,
                baggage: '23kg',
                operator: 'Air Astana'
            }
        ];

        // Helper functions
        function getStatusColor(status) {
            switch (status) {
                case 'On time':
                case 'Boarding':
                    return 'bg-green-50 text-green-700';
                case 'Delayed':
                    return 'bg-amber-50 text-amber-700';
                case 'Cancelled':
                    return 'bg-red-50 text-red-700';
                default:
                    return 'bg-slate-50 text-slate-700';
            }
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'On time':
                case 'Boarding':
                    return icons.checkCircle;
                case 'Delayed':
                    return icons.alertCircle;
                case 'Cancelled':
                    return icons.xCircle;
                default:
                    return '';
            }
        }

        // Component functions
        function renderWelcomePage() {
            return `
                <div class="w-full bg-white md:shadow-2xl md:shadow-slate-900/10 flex flex-col welcome-container md:rounded-2xl">
                    <!-- Header Section -->
                    <div class="relative bg-gradient-to-br from-[#1C2B4F] via-[#1C2B4F] to-[#243550] py-3 md:py-4 text-center flex-shrink-0 w-full">
                        <div class="absolute inset-0 grid-pattern opacity-30"></div>
                        
                        <div class="relative max-w-[440px] mx-auto px-3 md:px-4">
                            <!-- Logo -->
                            <div class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center mx-auto mb-2 shadow-xl">
                                <img 
                                    src="https://airastana.com/favicon.svg" 
                                    alt="Air Astana" 
                                    class="w-7 h-7 md:w-8 md:h-8"
                                    onerror="this.style.display='none'"
                                />
                            </div>
                            
                            <h1 class="text-lg md:text-xl font-bold text-white mb-0.5 tracking-tight">AURA <span class="text-xs md:text-sm text-blue-200 font-normal">v0.2.1</span></h1>
                            <p class="text-blue-100 text-xs md:text-sm mb-1.5 md:mb-2">Air Astana Digital Concierge</p>
                            <div class="flex items-center justify-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-green-400 pulse-dot shadow-lg shadow-green-400/50"></div>
                                <span class="text-sm text-blue-100">Available</span>
                            </div>
                        </div>
                    </div>

                    <!-- Content Section -->
                    <div class="overflow-y-auto flex-1 scrollbar-hide">
                        <div class="max-w-[440px] mx-auto px-3 md:px-4 pt-2 md:pt-3 pb-0">
                        <div class="text-center mb-2 md:mb-3">
                            <h2 class="text-slate-900 font-semibold mb-1 text-sm md:text-base">Welcome aboard!</h2>
                            <p class="text-xs md:text-sm text-slate-600 leading-relaxed">
                                I'm here to help you with flights and travel assistance.
                            </p>
                        </div>

                        <!-- Features Grid -->
                        <div class="grid grid-cols-2 gap-2 mb-2 md:mb-3">
                            ${[
                                { icon: 'search', title: 'Flight Status', description: 'Track flights in real-time' },
                                { icon: 'creditCard', title: 'Check-in', description: 'Check-in requirements' },
                                { icon: 'fileText', title: 'Travel Info', description: 'Baggage and policies' },
                                { icon: 'mapPin', title: 'Route Planning', description: 'Find flights and schedules' }
                            ].map(feature => `
                                <div class="bg-slate-50 border border-slate-200 rounded-lg p-2 md:p-3 hover:bg-slate-100 hover:border-slate-300 transition-all cursor-pointer group">
                                    <div class="flex items-center gap-2 mb-1.5 md:mb-2">
                                        <div class="w-8 h-8 md:w-9 md:h-9 rounded-lg bg-[#1C2B4F]/10 flex items-center justify-center group-hover:bg-[#1C2B4F]/15 transition-colors flex-shrink-0">
                                            <div class="w-4 h-4 md:w-5 md:h-5 text-[#1C2B4F] flex items-center justify-center" style="display: flex; align-items: center; justify-content: center;">${icons[feature.icon]}</div>
                                        </div>
                                        <h3 class="text-xs md:text-sm font-semibold text-slate-900 leading-tight">${feature.title}</h3>
                                    </div>
                                    <p class="text-xs text-slate-600 leading-relaxed">${feature.description}</p>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Footer Text -->
                        <p class="text-xs text-center text-slate-500">
                            Powered by Air Astana • Secure & Private
                        </p>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="flex-shrink-0 border-t border-slate-200 bg-white w-full">
                        <div class="max-w-[440px] mx-auto px-3 py-2 md:py-3" style="padding-bottom: max(8px, env(safe-area-inset-bottom));">
                            <div class="flex items-stretch gap-2">
                            <div class="flex-1 min-w-0">
                                <textarea 
                                    id="welcome-input"
                                    rows="1" 
                                    placeholder="Type your message here..."
                                    class="w-full h-11 md:h-12 px-3 md:px-4 py-2.5 md:py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#1C2B4F] focus:border-transparent resize-none text-sm"
                                    style="max-height: 120px; min-height: 44px;"
                                ></textarea>
                            </div>
                            <button 
                                onclick="startChat()"
                                class="w-11 h-11 md:w-12 md:h-12 bg-[#1C2B4F] text-white rounded-xl hover:bg-[#243550] transition-colors flex items-center justify-center flex-shrink-0"
                            >
                                <div class="w-5 h-5 md:w-6 md:h-6 flex items-center justify-center" style="display: flex; align-items: center; justify-content: center;">${icons.send}</div>
                            </button>
                        </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFlightCard(flight, variant = 'detailed', showPrice = false) {
            if (variant === 'compact') {
                return `
                    <div class="bg-white border border-slate-200 rounded-lg p-3 flight-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-sm text-slate-900">${flight.flightNumber}</span>
                            ${flight.status ? `
                                <div class="flex items-center gap-1 ${getStatusColor(flight.status)} px-2 py-0.5 rounded-full">
                                    <div class="w-3.5 h-3.5">${getStatusIcon(flight.status)}</div>
                                    <span class="text-xs font-medium">${flight.status}</span>
                                </div>
                            ` : ''}
                        </div>

                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-lg font-bold text-slate-900">${flight.departure.time}</p>
                                <p class="text-xs text-slate-500">${flight.from.code}</p>
                            </div>
                            
                            <div class="flex-1 mx-3 flex flex-col items-center">
                                <div class="w-4 h-4 text-slate-400 mb-1">${icons.plane}</div>
                                <div class="w-full border-t border-dashed border-slate-300"></div>
                                <p class="text-xs text-slate-500 mt-1">
                                    ${flight.stops === 0 ? 'Direct' : `${flight.stops} stop${flight.stops > 1 ? 's' : ''}`}
                                </p>
                            </div>
                            
                            <div class="text-right">
                                <p class="text-lg font-bold text-slate-900">${flight.arrival.time}</p>
                                <p class="text-xs text-slate-500">${flight.to.code}</p>
                            </div>
                        </div>

                        ${showPrice && flight.price ? `
                            <div class="flex items-center justify-between pt-2 border-t border-slate-100">
                                <p class="text-xs text-slate-600">
                                    ${flight.operator ? `Operated by ${flight.operator}` : ''}
                                </p>
                                <p class="font-semibold text-slate-900">
                                    ${flight.price.currency} ${flight.price.amount.toLocaleString()}
                                </p>
                            </div>
                            <button
                                class="w-full mt-3 bg-[#1C2B4F] text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-[#243550] transition-colors"
                            >
                                Book Flight
                            </button>
                        ` : ''}
                    </div>
                `;
            }

            // Detailed variant
            return `
                <div class="bg-white border border-slate-200 rounded-xl p-4 space-y-4 flight-card">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="font-semibold text-slate-900">${flight.flightNumber}</p>
                            <p class="text-sm text-slate-600 flex items-center gap-1.5 mt-0.5">
                                <div class="w-3.5 h-3.5">${icons.plane}</div>
                                ${flight.from.city} → ${flight.to.city}
                            </p>
                            ${flight.operator ? `
                                <p class="text-xs text-slate-500 mt-1">Operated by ${flight.operator}</p>
                            ` : ''}
                        </div>
                        ${flight.status ? `
                            <div class="flex items-center gap-1.5 ${getStatusColor(flight.status)} px-2.5 py-1 rounded-full">
                                <div class="w-3.5 h-3.5">${getStatusIcon(flight.status)}</div>
                                <span class="text-xs font-medium">${flight.status}</span>
                            </div>
                        ` : ''}
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-slate-500 mb-1">Departure</p>
                            <p class="text-xl font-bold text-slate-900">${flight.departure.time}</p>
                            <p class="text-sm text-slate-600">${flight.from.code}</p>
                            ${flight.from.terminal ? `
                                <p class="text-xs text-slate-500 mt-1">Terminal ${flight.from.terminal}</p>
                            ` : ''}
                        </div>

                        <div class="text-right">
                            <p class="text-xs text-slate-500 mb-1">Arrival</p>
                            <p class="text-xl font-bold text-slate-900">${flight.arrival.time}</p>
                            <p class="text-sm text-slate-600">${flight.to.code}</p>
                            ${flight.to.terminal ? `
                                <p class="text-xs text-slate-500 mt-1">Terminal ${flight.to.terminal}</p>
                            ` : ''}
                        </div>
                    </div>

                    <div class="flex items-center justify-between text-xs text-slate-600 pt-2 border-t border-slate-100">
                        ${flight.duration ? `
                            <div class="flex items-center gap-1">
                                <div class="w-3.5 h-3.5">${icons.clock}</div>
                                <span>${flight.duration}</span>
                            </div>
                        ` : ''}
                        <span>${flight.stops === 0 ? 'Direct flight' : `${flight.stops} stop(s)`}</span>
                        ${flight.gate ? `<span>Gate ${flight.gate}</span>` : ''}
                    </div>
                </div>
            `;
        }

        function renderChatView() {
            return `
                <div class="w-full bg-white md:shadow-2xl md:shadow-slate-900/10 flex flex-col chat-container md:rounded-2xl">
                    <!-- Header -->
                    <div id="chat-header" class="chat-header bg-gradient-to-r from-[#1C2B4F] to-[#243550] py-2 md:py-3 flex items-center justify-between flex-shrink-0 w-full">
                        <div class="w-full px-3 md:px-4 md:max-w-[440px] md:mx-auto flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-9 h-9 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center flex-shrink-0">
                                <img 
                                    src="https://airastana.com/favicon.svg" 
                                    alt="AURA" 
                                    class="w-5 h-5"
                                    onerror="this.style.display='none'"
                                />
                            </div>
                            <div>
                                <h2 class="text-white font-semibold text-sm">AURA <span class="text-xs text-blue-200">v0.2.1</span></h2>
                                <p class="text-blue-100 text-xs flex items-center gap-1.5">
                                    <span class="w-1.5 h-1.5 rounded-full bg-green-400 pulse-dot"></span>
                                    Online
                                </p>
                            </div>
                        </div>
                        <button 
                            onclick="goBackToWelcome()"
                            class="w-9 h-9 rounded-lg hover:bg-white/10 flex items-center justify-center transition-colors flex-shrink-0"
                        >
                            <div class="w-5 h-5 text-white flex items-center justify-center" style="display: flex; align-items: center; justify-content: center;">${icons.x}</div>
                        </button>
                        </div>
                    </div>
                    
                    <!-- Messages -->
                    <div id="messages-container" class="flex-1 overflow-y-auto scrollbar-hide" style="width: 100%; scroll-behavior: smooth; position: relative;">
                        <div class="w-full px-3 md:px-4 md:max-w-[440px] md:mx-auto space-y-3" style="width: 100%; padding-top: 12px; padding-bottom: 50vh;">
                        ${renderMessages()}
                        </div>
                        
                        <!-- Scroll to bottom button -->
                        <button 
                            id="scroll-to-bottom-btn"
                            onclick="scrollToEndOfMessage()"
                            class="hidden fixed bottom-20 md:bottom-24 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur-sm border-2 border-[#1C2B4F] text-[#1C2B4F] rounded-full p-2 shadow-lg hover:bg-white transition-all z-50"
                            style="display: none;"
                        >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M12 5v14M19 12l-7 7-7-7"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Input -->
                    <div class="flex-shrink-0 border-t border-slate-200 bg-white w-full">
                        <div class="w-full px-3 md:px-4 md:max-w-[440px] md:mx-auto py-2 md:py-3" style="padding-bottom: max(8px, env(safe-area-inset-bottom));">
                            <div class="flex items-stretch gap-2">
                            <button class="w-11 h-11 md:w-12 md:h-12 rounded-lg hover:bg-slate-100 flex items-center justify-center transition-colors flex-shrink-0">
                                <div class="w-5 h-5 md:w-6 md:h-6 text-slate-600 flex items-center justify-center" style="display: flex; align-items: center; justify-content: center;">${icons.paperclip}</div>
                            </button>
                            <div class="flex-1 min-w-0">
                                <textarea 
                                    id="chat-input"
                                    rows="1" 
                                    placeholder="Type your message..."
                                    class="w-full h-11 md:h-12 px-3 md:px-4 py-2.5 md:py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#1C2B4F] focus:border-transparent resize-none text-sm"
                                    style="max-height: 120px; min-height: 44px;"
                                    onkeydown="handleKeyDown(event)"
                                    onfocus="handleInputFocus()"
                                    onblur="handleInputBlur()"
                                ></textarea>
                            </div>
                            <button 
                                onclick="sendMessage()"
                                class="w-11 h-11 md:w-12 md:h-12 bg-[#1C2B4F] text-white rounded-xl hover:bg-[#243550] transition-colors flex items-center justify-center flex-shrink-0"
                            >
                                <div class="w-5 h-5 md:w-6 md:h-6 flex items-center justify-center" style="display: flex; align-items: center; justify-content: center;">${icons.send}</div>
                            </button>
                        </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMessages() {
            let html = '';
            
            // Рендерим в ХРОНОЛОГИЧЕСКОМ порядке (старые первые, новые последние)
            // НЕ делаем reverse!
            state.messages.forEach((msg, index) => {
                if (msg.type === 'user') {
                    // Добавляем дополнительный отступ перед user сообщением (начало нового обмена)
                    // Но НЕ для первого сообщения
                    const isFirstMessage = index === 0;
                    const extraMargin = !isFirstMessage ? 'mt-4' : ''; // +16px сверху
                    
                    html += `
                        <div class="flex justify-end w-full chat-message ${extraMargin}" style="display: flex !important; justify-content: flex-end !important; width: 100%;">
                            <div class="bg-[#1C2B4F] text-white rounded-2xl rounded-tr-none px-4 py-2.5 message-bubble max-w-[85%]">
                                <p class="text-sm">${msg.content}</p>
                            </div>
                        </div>
                    `;
                } else if (msg.type === 'assistant') {
                    html += `
                        <div class="flex gap-2 chat-message">
                            <div class="w-7 h-7 rounded-full bg-[#1C2B4F] flex items-center justify-center flex-shrink-0">
                                <div class="w-3.5 h-3.5 text-white">${icons.messageCircle}</div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="bg-slate-100 rounded-2xl rounded-tl-none px-4 py-2.5 inline-block message-bubble">
                                    <p class="text-sm text-slate-900 break-words">${msg.content}</p>
                                </div>
                                ${msg.flights ? renderFlightsInMessage(msg.flights) : ''}
                            </div>
                        </div>
                    `;
                } else if (msg.type === 'quick-actions') {
                    html += `
                        <div class="flex gap-2 chat-message">
                            <div class="w-8"></div>
                            <div class="flex flex-wrap gap-2">
                                ${msg.actions.map(action => `
                                    <button 
                                        onclick="handleQuickAction('${action.label}')"
                                        class="quick-action-btn bg-white border border-slate-300 px-3 py-2 rounded-full text-xs md:text-sm font-medium text-slate-700 hover:bg-slate-50 hover:border-slate-400 transition-all flex items-center gap-2"
                                    >
                                        <div class="w-4 h-4">${icons[action.icon]}</div>
                                        ${action.label}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            // Typing indicator в конце (последним)
            if (state.isTyping) {
                html += `
                    <div class="flex gap-2 chat-message">
                        <div class="w-7 h-7 rounded-full bg-[#1C2B4F] flex items-center justify-center flex-shrink-0">
                            <div class="w-3.5 h-3.5 text-white">${icons.messageCircle}</div>
                        </div>
                        <div class="bg-slate-100 rounded-2xl rounded-tl-none px-4 py-2.5 inline-block">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }

        function renderFlightsInMessage(flights) {
            const { type, data } = flights;
            
            if (type === 'detailed') {
                return `<div class="mt-3">${renderFlightCard(data, 'detailed')}</div>`;
            } else if (type === 'compact-list') {
                return `
                    <div class="mt-3 grid grid-cols-2 gap-2">
                        ${data.map(flight => renderFlightCard(flight, 'compact', true)).join('')}
                    </div>
                `;
            }
            
            return '';
        }

        // Event handlers
        async function startChat() {
            const input = document.getElementById('welcome-input');
            const message = input.value.trim();
            
            state.view = 'chat';
            state.messages = [];
            
            if (message) {
                state.messages.push({
                    type: 'user',
                    content: message
                });
            }
            
            // Render with message immediately
            render();
            
            if (message) {
                // Показываем typing indicator
                state.isTyping = true;
                render();
                scrollToBottom(true); // Плавный скролл
                
                // Get AI response
                await respondToMessage(message);
                state.isTyping = false;
            } else {
                scrollToBottom(true);
            }
        }

        function goBackToWelcome() {
            state.view = 'welcome';
            state.messages = [];
            render();
        }

        async function handleQuickAction(action) {
            if (action === 'Flight status') {
                await sendMessage('Show my flight status');
            } else if (action === 'Baggage rules') {
                await sendMessage('What are the baggage rules?');
            } else if (action === 'Flight schedule') {
                await sendMessage('Show me flight schedule');
            }
        }

        async function sendMessage(customMessage) {
            const input = document.getElementById('chat-input');
            const message = customMessage || input.value.trim();
            
            if (!message) return;
            
            state.messages.push({
                type: 'user',
                content: message
            });
            
            if (input) {
                input.value = '';
                input.style.height = 'auto';
            }
            
            render();
            
            // Get AI response
            state.isTyping = true;
            render();
            scrollToBottom(true); // Плавный скролл при отправке сообщения
            
            await respondToMessage(message);
            state.isTyping = false;
        }

        async function respondToMessage(message) {
            try {
                // System prompt с информацией об Air Astana
                const systemPrompt = `You are AURA, Air Astana's friendly and helpful digital concierge assistant. You help passengers with flight information, baggage policies, check-in procedures, and travel assistance.

**AIR ASTANA INFORMATION:**

**Company:**
- Flag carrier airline of Kazakhstan (founded 2001)
- Based in Almaty, Kazakhstan
- Main hubs: Almaty International Airport (ALA) and Astana International Airport (NQZ)
- Subsidiary airline: FlyArystan
- IATA code: KC

**Baggage Policy:**
Economy Class:
- Carry-on: 1 bag up to 8kg (56×45×25 cm)
- Checked baggage depends on fare:
  * Basic: 0 kg (no free checked baggage)
  * Classic: 1 piece up to 23kg
  * Plus: 2 pieces up to 23kg each
- Maximum dimensions per bag: 158 cm total (length + width + height)

Business Class:
- Carry-on: 2 bags up to 8kg each
- Checked: 2 pieces up to 32kg each

Premium Economy / Sleeper Class:
- Checked: 2 pieces up to 32kg each (on Boeing 757 flights)

Additional Baggage:
- 30% discount if purchased 36+ hours before departure
- Standard rates apply at airport if purchased less than 36 hours before
- Maximum weight per piece: 32kg
- Baggage over 32kg not accepted (use Air Astana Cargo)
- Can purchase up to 10 extra pieces

Special Items:
- Strollers: Free for infants under 2 years (folded size 34×32×14cm)
- Sports equipment: Special rates may apply
- Musical instruments: Specific guidelines available
- Pets: Available in cabin or cargo hold (advance booking required)

**Online Check-in:**
- Available 24 hours to 1 hour before departure
- Not available for charter flights
- Available routes include:
  * All domestic Kazakhstan flights
  * International: Istanbul, Bishkek, Tbilisi, Antalya, Dubai, Amsterdam, Frankfurt, London, Bangkok, Delhi, Seoul, and more
- Unaccompanied minors must check in at airport

**Destinations:**
Domestic (10 cities in Kazakhstan):
- Almaty (ALA), Astana (NQZ), Atyrau (GUW), Aktau (SCO), Aktobe (AKX), Kyzylorda (KZO), Shymkent (CIT), Oral/Uralsk (URA), Oskemen/Ust-Kamenogorsk (UKK), Kostanay (KSN)

International (30+ destinations):
Popular routes:
- Europe: London (LHR), Frankfurt (FRA), Amsterdam (AMS), Istanbul (IST)
- Middle East: Dubai (DXB), Abu Dhabi (AUH), Jeddah (JED)
- Asia: Bangkok (BKK), Phuket (HKT), Seoul (ICN), Delhi (DEL), Beijing (PEK), Urumqi (URC), Phu Quoc (PQC)
- CIS: Moscow, Tbilisi (TBS), Bishkek (FRU), Tashkent (TAS), Baku (GYD)

**Airport Codes (IATA):**
Kazakhstan Domestic:
- ALA = Almaty
- NQZ = Astana (Nursultan Nazarbayev International)
- GUW = Atyrau
- SCO = Aktau
- AKX = Aktobe
- KZO = Kyzylorda
- CIT = Shymkent
- URA = Oral (Uralsk)
- UKK = Oskemen (Ust-Kamenogorsk)
- KSN = Kostanay

**Flight Status:**
- Can check flight status by route (departure/arrival airports) or flight number
- Flight numbers format: KC + 3-4 digits (e.g., KC854, KC101)
- Use the check_flight_status tool when user asks about flight status

**Nomad Club - Loyalty Program:**
- Free membership
- Three tiers: Silver, Gold, Diamond
- Benefits:
  * Silver: +1 extra baggage piece
  * Gold/Diamond: +2 extra baggage pieces
  * Priority check-in, boarding, lounge access (higher tiers)

**In-Flight Services:**
Economy Class:
- Complimentary meals with regional cuisine
- In-flight entertainment system
- Wi-Fi connectivity
- Amenity kits

Business Class:
- Premium meals
- Reclining seats
- Lounge access (Shanyrak lounge in Astana, partner lounges internationally)
- Priority services

**Important Policies:**
- Airport check-in deadline: 40 minutes before departure (60 minutes for Kuala Lumpur, Dubai, Delhi, Istanbul)
- Dangerous goods strictly prohibited
- Fragile/valuable items should be in carry-on
- Codeshare partners: Air France, KLM, Turkish Airlines, Etihad, and others

**Response Guidelines:**
- Be warm, friendly, and professional
- Keep responses concise and helpful
- Provide specific information when asked
- If you don't know something, admit it and suggest contacting Air Astana directly
- Use natural, conversational language
- You can respond in English or Russian based on user's language
- Always aim to be helpful and solve the passenger's query`;

                // Определяем tools (функции которые может вызвать Claude)
                const tools = [
                    {
                        name: "check_flight_status",
                        description: "Check the status of Air Astana flights. Can search by route (departure and arrival airports) or by flight number. Use this when user asks about flight status, flight information, or wants to track a specific flight.",
                        input_schema: {
                            type: "object",
                            properties: {
                                type: {
                                    type: "string",
                                    enum: ["route", "flightNumber"],
                                    description: "Search by 'route' (departure/arrival airports) or 'flightNumber' (specific flight number)"
                                },
                                departurePort: {
                                    type: "string",
                                    description: "IATA code of departure airport (e.g., ALA for Almaty). Required if type is 'route'"
                                },
                                arrivalPort: {
                                    type: "string",
                                    description: "IATA code of arrival airport (e.g., NQZ for Astana). Required if type is 'route'"
                                },
                                flightNumber: {
                                    type: "string",
                                    description: "Flight number (e.g., KC854, KC101). Required if type is 'flightNumber'"
                                },
                                date: {
                                    type: "string",
                                    enum: ["0", "1", "2"],
                                    description: "0 = yesterday, 1 = today, 2 = tomorrow. Default is '1' (today)"
                                }
                            },
                            required: ["type"]
                        }
                    }
                ];

                // Вызываем Claude API
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        system: systemPrompt,
                        tools: tools,
                        messages: [
                            { role: "user", content: message }
                        ],
                    })
                });

                const data = await response.json();
                
                // Проверяем нужно ли вызвать tool
                const toolUse = data.content.find(item => item.type === "tool_use");
                
                if (toolUse && toolUse.name === "check_flight_status") {
                    // Claude хочет проверить статус рейса
                    const params = toolUse.input;
                    
                    // Формируем URL для API
                    let url = "https://airastana.com/kaz-ru/flight-status?";
                    
                    if (params.type === "route") {
                        url += `arrivalPort=${params.arrivalPort || ''}&departurePort=${params.departurePort || ''}&date=${params.date || '1'}&flightNumber=&type=route`;
                    } else {
                        url += `arrivalPort=&departurePort=&date=${params.date || '1'}&flightNumber=${params.flightNumber || ''}&type=flightNumber`;
                    }
                    
                    // Получаем данные о рейсе
                    try {
                        const flightResponse = await fetch(url);
                        const flightData = await flightResponse.text();
                        
                        // Возвращаем результат обратно Claude для форматирования
                        const finalResponse = await fetch("https://api.anthropic.com/v1/messages", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                model: "claude-sonnet-4-20250514",
                                max_tokens: 1000,
                                system: systemPrompt,
                                tools: tools,
                                messages: [
                                    { role: "user", content: message },
                                    { role: "assistant", content: data.content },
                                    {
                                        role: "user",
                                        content: [
                                            {
                                                type: "tool_result",
                                                tool_use_id: toolUse.id,
                                                content: flightData
                                            }
                                        ]
                                    }
                                ],
                            })
                        });
                        
                        const finalData = await finalResponse.json();
                        
                        // Извлекаем финальный ответ
                        const assistantMessage = finalData.content
                            .filter(item => item.type === "text")
                            .map(item => item.text)
                            .join("\n");
                        
                        state.messages.push({
                            type: 'assistant',
                            content: assistantMessage || "I found the flight information but had trouble formatting it. Please try again."
                        });
                        
                    } catch (fetchError) {
                        console.error("Error fetching flight status:", fetchError);
                        state.messages.push({
                            type: 'assistant',
                            content: "I'm sorry, I couldn't retrieve the flight status at this moment. Please try again or check airastana.com directly."
                        });
                    }
                } else {
                    // Обычный текстовый ответ (без tool use)
                    const assistantMessage = data.content
                        .filter(item => item.type === "text")
                        .map(item => item.text)
                        .join("\n");

                    state.messages.push({
                        type: 'assistant',
                        content: assistantMessage || "I apologize, I'm having trouble responding right now. Please try again."
                    });
                }
                
            } catch (error) {
                console.error("Error calling Claude API:", error);
                state.messages.push({
                    type: 'assistant',
                    content: "I apologize, I'm experiencing technical difficulties. Please try again in a moment."
                });
            }
            
            render();
            scrollToBottom(false); // Мгновенный скролл чтобы не было дергания
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
            
            // Auto-resize textarea
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Флаг программного скролла
        let isProgrammaticScroll = false;
        
        function scrollToBottom(smooth = true) {
            const container = document.getElementById('messages-container');
            if (container) {
                // Устанавливаем флаг что это программный скролл
                isProgrammaticScroll = true;
                
                // Используем requestAnimationFrame для синхронизации с браузером
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        // Находим все сообщения
                        const messages = container.querySelectorAll('.chat-message');
                        if (messages.length > 0) {
                            // Ищем ПОСЛЕДНЕЕ USER сообщение (с justify-end)
                            let lastUserMessage = null;
                            for (let i = messages.length - 1; i >= 0; i--) {
                                if (messages[i].classList.contains('justify-end')) {
                                    lastUserMessage = messages[i];
                                    break;
                                }
                            }
                            
                            // Скроллим к последнему user сообщению
                            if (lastUserMessage) {
                                // Получаем позицию элемента относительно контейнера
                                const messageTop = lastUserMessage.offsetTop;
                                
                                if (smooth) {
                                    // Плавный скролл (первый раз)
                                    container.scrollTo({
                                        top: messageTop - 16,
                                        behavior: 'auto' // CSS scroll-behavior: smooth сработает
                                    });
                                } else {
                                    // Мгновенный скролл (при появлении ответа)
                                    container.style.scrollBehavior = 'auto';
                                    container.scrollTop = messageTop - 16;
                                    // Возвращаем обратно
                                    setTimeout(() => {
                                        container.style.scrollBehavior = '';
                                    }, 0);
                                }
                            }
                        }
                        
                        // Проверяем нужна ли кнопка скролла
                        updateScrollButton();
                        
                        // Сбрасываем флаг через 500ms (после завершения анимации)
                        setTimeout(() => {
                            isProgrammaticScroll = false;
                        }, 500);
                    });
                });
            }
        }
        
        // Скролл к концу последнего сообщения AURA
        function scrollToEndOfMessage() {
            const container = document.getElementById('messages-container');
            const messages = container.querySelectorAll('.chat-message');
            
            // Находим последнее assistant сообщение
            let lastAssistantMessage = null;
            for (let i = messages.length - 1; i >= 0; i--) {
                if (!messages[i].classList.contains('justify-end')) {
                    lastAssistantMessage = messages[i];
                    break;
                }
            }
            
            if (lastAssistantMessage) {
                // Скроллим к низу последнего assistant сообщения
                const messageBottom = lastAssistantMessage.offsetTop + lastAssistantMessage.offsetHeight;
                container.scrollTo({
                    top: messageBottom - container.clientHeight + 20, // 20px отступ снизу
                    behavior: 'smooth'
                });
            }
        }
        
        // Проверяем нужна ли кнопка скролла вниз
        function updateScrollButton() {
            const container = document.getElementById('messages-container');
            const button = document.getElementById('scroll-to-bottom-btn');
            const messages = container.querySelectorAll('.chat-message');
            
            if (!button || messages.length === 0) return;
            
            // Находим последнее assistant сообщение
            let lastAssistantMessage = null;
            for (let i = messages.length - 1; i >= 0; i--) {
                if (!messages[i].classList.contains('justify-end')) {
                    lastAssistantMessage = messages[i];
                    break;
                }
            }
            
            if (lastAssistantMessage) {
                const messageBottom = lastAssistantMessage.offsetTop + lastAssistantMessage.offsetHeight;
                const containerBottom = container.scrollTop + container.clientHeight;
                
                // Показываем кнопку если есть контент ниже (больше 100px скрыто)
                if (messageBottom - containerBottom > 100) {
                    button.style.display = 'block';
                } else {
                    button.style.display = 'none';
                }
            }
        }
        
        // Лимит скролла - не даем ответу AURA уйти полностью
        function limitScroll() {
            // Не применяем лимит во время программного скролла
            if (isProgrammaticScroll) return;
            
            const container = document.getElementById('messages-container');
            const messages = container.querySelectorAll('.chat-message');
            
            if (messages.length === 0) return;
            
            // Находим последнее assistant сообщение
            let lastAssistantMessage = null;
            for (let i = messages.length - 1; i >= 0; i--) {
                if (!messages[i].classList.contains('justify-end')) {
                    lastAssistantMessage = messages[i];
                    break;
                }
            }
            
            if (lastAssistantMessage) {
                const messageBottom = lastAssistantMessage.offsetTop + lastAssistantMessage.offsetHeight;
                const containerTop = container.scrollTop;
                
                // Минимум 100px последнего ответа должно быть видно
                const minVisibleHeight = 100;
                const maxScroll = messageBottom - minVisibleHeight;
                
                if (containerTop > maxScroll) {
                    container.scrollTop = maxScroll;
                }
            }
            
            // Проверяем кнопку
            updateScrollButton();
        }

        // Handle input focus - hide header on mobile
        function handleInputFocus() {
            // Убрали скрытие header - он всегда видим для стабильности
        }

        // Handle input blur - show header again
        function handleInputBlur() {
            // Убрали скрытие header - он всегда видим для стабильности
        }

        // Main render function
        function render() {
            const app = document.getElementById('app');
            
            if (state.view === 'welcome') {
                app.innerHTML = renderWelcomePage();
                
                // Auto-resize textarea
                const textarea = document.getElementById('welcome-input');
                if (textarea) {
                    // Убрали автофокус - клавиатура не открывается автоматически
                    
                    textarea.addEventListener('input', function() {
                        this.style.height = 'auto';
                        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                    });
                    
                    textarea.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            startChat();
                        }
                    });
                }
            } else {
                app.innerHTML = renderChatView();
                
                // Force layout calculation immediately
                app.offsetHeight;
                
                // Focus input (убрали автофокус)
                const input = document.getElementById('chat-input');
                if (input) {
                    // Убрали автофокус - клавиатура не открывается автоматически
                    
                    // Auto-resize textarea
                    input.addEventListener('input', function() {
                        this.style.height = 'auto';
                        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                    });
                }
                
                // Добавляем scroll listener для лимита и кнопки
                const messagesContainer = document.getElementById('messages-container');
                if (messagesContainer) {
                    messagesContainer.addEventListener('scroll', () => {
                        // Если пользователь скроллит вручную, сбрасываем флаг
                        // (но даем программному скроллу завершиться)
                        setTimeout(() => {
                            limitScroll();
                        }, 10);
                    });
                }
            }
        }

        // Initialize
        function initApp() {
            render();
            
            // Fade out loader screen after 1 second
            setTimeout(() => {
                const loaderScreen = document.getElementById('loader-screen');
                if (loaderScreen) {
                    loaderScreen.classList.add('fade-out');
                    setTimeout(() => {
                        loaderScreen.style.display = 'none';
                    }, 500);
                }
            }, 1000);
        }
        
        // Handle different loading states
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
